---
title: "Ch10-02-logisticreg"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Replicating the Analysis in 10.5: Predicting Delayed Flights

This is a complete beginning to end analysis. Please, absolutely follow along with Section 10.5 in the textbook for this to make sense. I will provide some analysis here but it only supplements the textbook.

Also, the methods we will do here are very generic and can be used in applied in any classification algorithm you want to run, including the k-nn and classification tree approach. 

Set up the environment

```{r}
library(tidyverse)
library(gains)
library(caret)
library(yardstick)
library(broom)
library(pROC)

fl.df <- read.csv("FlightDelays.csv")
glimpse(fl.df)
```

Flight.Status is the outcome variable. We want to predict "delayed" on new flights. Let us plot some intial bar charts to see delay based on DAY-WEEK, DEST, ORIGIN, CARRIERS.

One small data step is to label days of week.

```{r}
fl.df$DAY_WEEK <- factor(fl.df$DAY_WEEK, 
                         levels = c(1:7),
                         labels = c("Mon", "Tue", "Wed",
                                    "Thr", "Fri", "Sat", "Sun"))


```

We will first group by the various categorical variables and then graph them. 

__Note: The book has incorrect code and graphs.__ They have the correct commentary though. So, ignore the graphs in the book and look at these graphs.
```{r}

fl.day <- fl.df %>% 
  group_by(DAY_WEEK, Flight.Status) %>% 
  summarise(n = n()) %>% 
  mutate(pct.delayed = n/sum(n)) %>% 
  filter(Flight.Status == "delayed")

ggplot(fl.day, aes(x= DAY_WEEK, y = pct.delayed))+
  geom_col()

```

For other categorical varilables, we will just replace the grouping variables and the x variable.

```{r}
fl.dest <- fl.df %>% 
  group_by(DEST, Flight.Status) %>% 
  summarise(n = n()) %>% 
  mutate(pct.delayed = n/sum(n)) %>% 
  filter(Flight.Status == "delayed")

ggplot(fl.dest, aes(x = DEST, y = pct.delayed))+
    geom_col()
```



```{r}

fl.carrier <- fl.df %>% 
  group_by(CARRIER, Flight.Status) %>% 
  summarise(n = n()) %>% 
  mutate(pct.delayed = n/sum(n)) %>% 
  filter(Flight.Status == "delayed")

ggplot(fl.carrier, aes(x = CARRIER, y = pct.delayed))+
    geom_col()

```

```{r}
fl.Weather <- fl.df %>% 
  group_by(Weather, Flight.Status) %>% 
  summarise(n = n()) %>% 
  mutate(pct.delayed = n/sum(n)) %>% 
  filter(Flight.Status == "delayed")


ggplot(fl.Weather, aes(x = factor(Weather), y = pct.delayed))+
    geom_col()


```

Let's get a heatmap to get delays by day of the week, carrier and split by Origin (Fig 10.5)

```{r}

fl.heat <- fl.df %>% 
  group_by(DAY_WEEK, CARRIER, ORIGIN, Flight.Status) %>% 
  summarise(n = n()) %>% 
  mutate(pct.delayed = n /sum(n)) %>% 
  filter(Flight.Status == "delayed")

fl.heat %>% 
  ggplot(aes(x = DAY_WEEK, y = CARRIER, fill = pct.delayed)) +
    geom_tile()+
    facet_grid(ORIGIN ~ ., scales = "free", space = "free") +
    scale_fill_gradient(low = "lightblue", high = "orange")
```

Now, we need to create some categorical variables and relevel some others.
```{r}
fl.df$DEP_HR <- factor(round(fl.df$DEP_TIME/100))
fl.df$DEST <- relevel(factor(fl.df$DEST), ref = "LGA")
fl.df$CARRIER <- relevel(factor(fl.df$CARRIER), ref = "US")
fl.df$DAY_WEEK <- relevel(factor(fl.df$DAY_WEEK), ref = "Wed")
fl.df$isDelay <- 1 * (fl.df$Flight.Status == "delayed")



```

Train data

```{r}

drop.var <- c("CRS_DEP_TIME", "DEP_TIME" ,  "DISTANCE", "FL_DATE", "FL_NUM", "DAY_OF_MONTH", "TAIL_NUM", "Flight.Status")

fl.df <- fl.df %>% 
  select(-drop.var)


set.seed(123)
train.index <- sample(c(1:dim(fl.df)[1]), dim(fl.df)[1]*0.6)  
train.df <- fl.df[train.index, ]
valid.df <- fl.df[-train.index, ]
```

Now carryout a logistic regression and create a confusion matrix for validation set. Also produce a lift curve.

```{r}
# run logistic model, and show coefficients and odds
logit.reg.1 <- glm(isDelay ~ ., data = train.df, family = "binomial")

result.1 <- tidy(logit.reg.1, exponentiate = T)

result.1 %>% 
  mutate(estimate = round(estimate,2),
         p.value = round(p.value, 4))
```

```{r}
log.pred.valid <- augment(logit.reg.1,
                          newdata = valid.df,
                          type.predict = "response")

log.pred.valid2 <- log.pred.valid %>% 
  select(isDelay, `.fitted`) %>%
  mutate(isDelay.pred = ifelse(.fitted >0.5,1,0),
         actual.class = factor(isDelay,order = T,
                               levels = c("1", "0")),
         pred.class = factor(isDelay.pred,order = T,
                             levels = c("1", "0")))

## For confusion matrix, we need factors as classes


confusionMatrix(log.pred.valid2$pred.class, log.pred.valid2$actual.class)

lift1 <- lift_curve(log.pred.valid2, actual.class, .fitted)
autoplot(lift1)

```

Now let us reduce the predictors. We will go back to the full data and redo some of the analysis.

```{r}
fl.df <- read.csv("FlightDelays.csv")

fl.df$DAY_WEEK <- factor(fl.df$DAY_WEEK, 
                         levels = c(1:7),
                         labels = c("Mon", "Tue", "Wed",
                                    "Thr", "Fri", "Sat", "Sun"))

fl.df$DEP_HR <- factor(round(fl.df$CRS_DEP_TIME/100))
fl.df$DEST <- relevel(factor(fl.df$DEST), ref = "LGA")
fl.df$CARRIER <- relevel(factor(fl.df$CARRIER), ref = "US")
fl.df$DAY_WEEK <- relevel(factor(fl.df$DAY_WEEK), ref = "Wed")
fl.df$isDelay <- 1 * (fl.df$Flight.Status == "delayed")

fl.df$Weekend <- fl.df$DAY_WEEK %in% c("Sun", "Sat")

fl.df$CARRIER_CO_MQ_DH_RU <- fl.df$CARRIER %in% c("CO", "MQ", "DH", "RU")


fl.df$DEP_HR <- factor(round(fl.df$DEP_TIME/100))
fl.df$MORNING <- fl.df$DEP_HR %in% c(6, 7, 8, 9)
fl.df$NOON <- fl.df$DEP_HR %in% c(10, 11, 12, 13)
fl.df$AFTER2P <- fl.df$DEP_HR %in% c(14, 15, 16, 17, 18)
fl.df$EVENING <- fl.df$DEP_HR %in% c(19, 20)
fl.df$isDelay <- 1 * (fl.df$Flight.Status == "delayed")
```

```{r}


set.seed(1)
train.index <- sample(c(1:dim(fl.df)[1]), dim(fl.df)[1]*0.6)  
train.df <- fl.df[train.index, ]
valid.df <- fl.df[-train.index, ]
```

Now model it:

```{r}
logit.reg.2 <- glm(isDelay ~ Weekend + CARRIER_CO_MQ_DH_RU +
                   Weather + MORNING + NOON + AFTER2P +
                     EVENING, data = train.df, family = "binomial")

result.2 <- tidy(logit.reg.2, exponentiate = T)

result.2 %>% 
  mutate(estimate = round(estimate,2),
         p.value = round(p.value, 4))

```

```{r}
log.pred.valid <- augment(logit.reg.2,
                          newdata = valid.df,
                          type.predict = "response")

log.pred.valid2 <- log.pred.valid %>% 
  select(isDelay, `.fitted`) %>%
  mutate(isDelay.pred = ifelse(.fitted >0.5,1,0),
         actual.class = factor(isDelay,order = T,
                               levels = c("1", "0")),
         pred.class = factor(isDelay.pred,order = T,
                             levels = c("1", "0")))

## For confusion matrix, we need factors as classes


confusionMatrix(log.pred.valid2$pred.class, log.pred.valid2$actual.class)

lift1 <- lift_curve(log.pred.valid2, actual.class, .fitted)
autoplot(lift1)

```

