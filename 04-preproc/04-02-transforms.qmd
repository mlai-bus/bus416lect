---
title: "04-02-transforms"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
```

In this module, we will learn about transforming data and dimension reduction using principal components analysis.

Load the libraries

```{r, echo = F}
library(tidyverse)
library(caret)
library(readr)

```

### Standardizing data

```{r}
df1 <- read_csv("Cereals.csv") 
glimpse(df1)
```

Caret has a nice function to do the various preprocessing steps

```{r}

transf <- preProcess(df1, method = c("center", "scale"))

df2 <- predict(transf, newdata = df1)
glimpse(df2)

```

In the above, character columns are left untouched while everything else is standardized.

### Principal Components Analysis

For the theory behind principal components, refer to the class discussion. Let us first work with calories and ratings variables. Our objective is to see if we can combine these two variables into another which is a linear combination of these two but captures most of the information contained in these two variables.

```{r}
df1.sm <- df1[, c(4,16)]

summary(df1.sm)
cov(df1.sm)
cor(df1.sm)


```


We see that both these variables are highly correlated. Correlation is `r cor(df1.sm)[1,2]`. If we consider the variance of each predictor as the information conveyed by it, we can get the relative information by as the variance/total.variance.

```{r}
info.share <- cov(df1.sm)/(sum(diag(cov(df1.sm)))) * 100
info.share
```

Thus calories carries `r info.share[1,1]`  percent of the total variation while rating carries `r paste0(round(info.share[2,2],2), "%")` .

Principal components is the method that will help us find linear combinations of these variables that will capture most of the information.

```{r}

pcs <- prcomp(df1.sm) 

summary(pcs) # tells us share of variance captured by each component

pcs$rot # gives the weight for each variable to calculate the principal comp.

```

For example, for the first cereal, 100% Bran, calories = 70 and rating = 68.4. The averages across the data for these variables are: 106.9 and 42.67. The first principal component for 100% Bran will be $0.847(70-106.9)  + (-0.531)(68.4 - 42.67) = -44.92$. 



```{r}
scores <- pcs$x
head(scores, 10)
```

We can plot various aspects of the analysis to see the transformations that take place. 

```{r ,echo=FALSE}
# install.packages("remotes")
#library(remotes)
#install_github("vqv/ggbiplot")

library(ggbiplot)

```

```{r}
ggbiplot(pcs)

ggscreeplot(pcs)

```

Biplot: The direction on the vectors and the magnitude indicates the principal component towards which that variable contributes. Thus calories contribute heavily towards PC1, while rating loads towards PC2.

Scree plot: The scree plot tells us the share of variance explained by each of the principal components. Typically, we only include the components above the "elbow". 

One problems with this analysis however is that the scale of these variables is different and the larger variable can dominate the principal components. We should first standardize the variables. Let us now do a complete analysis on the cereals dataset.

```{r}
# Let us omit all missing values

df3 <- na.omit(df1)

full.pcs1 <- prcomp(df3[, -c(1:3)], scale. = T)

summary(full.pcs1)
full.pcs1

# 8 PCs are needed to capture 95% of the variation

full.pcs1$rotation[, 1:8]

# We can get the transformed dataset
head(full.pcs1$x)

ggbiplot(full.pcs1)

ggscreeplot(full.pcs1)

```


If we wanted to just use pca as an intermediary step to data analysis (for example, regression), we could use `caret` and carry out pca as a preprocessing step.

```{r}
full.pcs2 <- preProcess(df3[,-c(1:3)],
                       method = c("center", "scale", "pca"), 
                       # the following two options can be customized
                       #thresh = 0.95, 
                       #pcaComp = 10
                       )

full.pcs2
full.pcs2$rotation

#predicting the transformed dataset

df3.transf <- predict(full.pcs2, newdata = df3)

```

